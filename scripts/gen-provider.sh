#!/bin/bash
#
# Init variables and sanity checks
DIR=$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )
PROFILE=${PROFILE:-"coreos-cluster"}
TF_VAR_aws_access_key=$($DIR/read_cfg.sh $HOME/.aws/credentials $PROFILE aws_access_key_id)
TF_VAR_aws_secret_key=$($DIR/read_cfg.sh $HOME/.aws/credentials $PROFILE aws_secret_access_key)
TF_VAR_aws_region=$($DIR/read_cfg.sh $HOME/.aws/config "profile $PROFILE" region)
TF_VAR_aws_account=$(aws --profile $PROFILE iam get-user --user-name=$PROFILE | jq ".User.Arn" | grep -Eo '[[:digit:]]{12}')

cat <<EOF
# Generated by scripts/gen-provider.sh
provider "aws" {
  access_key = "$TF_VAR_aws_access_key"
  secret_key = "$TF_VAR_aws_secret_key"
  region = "$TF_VAR_aws_region"
}
variable "aws_account" {
    default = {
        id = "$TF_VAR_aws_account"
        user = "$PROFILE"
        defualt_region = "$TF_VAR_aws_region"
    }
}
EOF